<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="VUMC Guide">
    <title>VUMC Trauma Guide</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f2f2f7;
            color: #1c1c1e;
            height: 100vh;
            overflow: hidden;
            position: fixed;
            width: 100%;
        }

        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #f2f2f7;
        }

        .header {
            background: #007AFF;
            color: white;
            padding: env(safe-area-inset-top) 20px 15px;
            text-align: center;
            box-shadow: 0 1px 0 rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
        }

        .api-key-banner {
            background: #ffcc00;
            color: #000;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .api-key-banner input {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .api-key-banner button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 20px;
            padding-bottom: 100px;
        }

        .message {
            margin-bottom: 16px;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-message {
            text-align: right;
        }

        .user-message .bubble {
            background: #007AFF;
            color: white;
            display: inline-block;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 80%;
            text-align: left;
            word-wrap: break-word;
        }

        .bot-message .bubble {
            background: white;
            color: #1c1c1e;
            display: inline-block;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 90%;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            word-wrap: break-word;
        }

        .bot-message .bubble a {
            color: #007AFF;
            text-decoration: none;
            font-weight: 500;
        }

        .voice-button-container {
            position: fixed;
            bottom: env(safe-area-inset-bottom);
            left: 0;
            right: 0;
            background: #f2f2f7;
            padding: 20px;
            display: flex;
            justify-content: center;
            border-top: 1px solid #e5e5ea;
        }

        .voice-button {
            width: 80px;
            height: 80px;
            border-radius: 40px;
            border: none;
            background: #007AFF;
            color: white;
            font-size: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0,122,255,0.3);
            transition: all 0.3s;
            cursor: pointer;
        }

        .voice-button:active {
            transform: scale(0.95);
        }

        .voice-button.listening {
            background: #ff3b30;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 4px 10px rgba(255,59,48,0.3); }
            50% { box-shadow: 0 4px 20px rgba(255,59,48,0.6); }
            100% { box-shadow: 0 4px 10px rgba(255,59,48,0.3); }
        }

        .listening-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px 40px;
            border-radius: 20px;
            font-size: 18px;
            display: none;
            z-index: 1000;
        }

        .listening-indicator.active {
            display: block;
        }

        .quick-actions {
            padding: 10px;
            display: flex;
            gap: 8px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .quick-actions::-webkit-scrollbar {
            display: none;
        }

        .quick-button {
            background: white;
            border: 1px solid #e5e5ea;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            white-space: nowrap;
            color: #007AFF;
            font-weight: 500;
            flex-shrink: 0;
        }

        .loading-dots {
            display: inline-block;
        }

        .loading-dots::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        .protocol-link {
            display: block;
            margin-top: 8px;
            padding: 8px;
            background: #f2f2f7;
            border-radius: 8px;
            font-size: 14px;
        }

        /* iOS specific adjustments */
        @supports (padding: env(safe-area-inset-bottom)) {
            .voice-button-container {
                padding-bottom: calc(20px + env(safe-area-inset-bottom));
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>VUMC Trauma Guidelines</h1>
        </div>

        <div class="api-key-banner" id="apiKeyBanner">
            <span>ðŸ”‘</span>
            <input type="password" id="apiKeyInput" placeholder="Enter OpenAI API key">
            <button onclick="saveApiKey()">Save</button>
        </div>

        <div class="quick-actions">
            <button class="quick-button" onclick="askQuestion('What are the massive transfusion criteria?')">
                Massive Transfusion
            </button>
            <button class="quick-button" onclick="askQuestion('How do I grade a liver injury?')">
                Liver Injury
            </button>
            <button class="quick-button" onclick="askQuestion('What is the TBI protocol?')">
                TBI Protocol
            </button>
            <button class="quick-button" onclick="askQuestion('When do I clear a C-collar?')">
                C-Collar
            </button>
            <button class="quick-button" onclick="askQuestion('ECMO indications?')">
                ECMO
            </button>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="message bot-message">
                <div class="bubble">
                    ðŸ‘‹ Hi! I'm your VUMC trauma guidelines assistant. 
                    <br><br>
                    Tap the microphone button and ask me about:
                    <br>â€¢ Injury grading (liver, spleen, kidney)
                    <br>â€¢ Treatment protocols
                    <br>â€¢ Massive transfusion
                    <br>â€¢ TBI management
                    <br>â€¢ And more!
                    <br><br>
                    First, please enter your OpenAI API key above.
                </div>
            </div>
        </div>

        <div class="listening-indicator" id="listeningIndicator">
            ðŸŽ¤ Listening...
        </div>

        <div class="voice-button-container">
            <button class="voice-button" id="voiceButton" onclick="toggleVoice()" disabled>
                ðŸŽ¤
            </button>
        </div>
    </div>

    <script>
        // Configuration
        let apiKey = localStorage.getItem('vumc_api_key') || '';
        let isListening = false;
        let recognition = null;
        let speechSynthesis = window.speechSynthesis;

        // Protocol URLs
        const protocols = {
            "Kidney Injury": "https://www.vumc.org/trauma-and-scc/sites/default/files/public_files/Protocols/KIDNEY_INJURY_GRADES-CODES_031522.pdf",
            "Liver Injury": "https://www.vumc.org/trauma-and-scc/sites/default/files/public_files/Protocols/LIVER_INJURY_GRADES-CODES_031522.pdf",
            "Spleen Injury": "https://www.vumc.org/trauma-and-scc/sites/default/files/public_files/Protocols/SPLEEN_INJURY_GRADES-CODES_031522.pdf",
            "TBI": "https://www.vumc.org/trauma-and-scc/sites/default/files/public_files/Protocols/TBI-Pathways-PMG-v2023.pdf",
            "Massive Transfusion": "https://www.vumc.org/trauma-and-scc/sites/default/files/public_files/Protocols/VUMC%20Massive%20Transfusion%20Protocol.pdf",
            "C-Collar": "https://www.vumc.org/trauma-and-scc/sites/default/files/public_files/Protocols/C-Collar%20Clearance%20PMG%202023.pdf",
            "ECMO": "https://www.vumc.org/trauma-and-scc/sites/default/files/public_files/ECMO_PMG_1.2025.pdf"
        };

        // Initialize
        window.onload = function() {
            if (apiKey) {
                document.getElementById('apiKeyBanner').style.display = 'none';
                document.getElementById('voiceButton').disabled = false;
                addMessage("Ready to help! Tap the microphone to ask a question.", 'bot');
            }
            
            // Setup speech recognition
            setupSpeechRecognition();
        };

        function setupSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.lang = 'en-US';

                recognition.onstart = function() {
                    isListening = true;
                    document.getElementById('voiceButton').classList.add('listening');
                    document.getElementById('listeningIndicator').classList.add('active');
                };

                recognition.onend = function() {
                    isListening = false;
                    document.getElementById('voiceButton').classList.remove('listening');
                    document.getElementById('listeningIndicator').classList.remove('active');
                };

                recognition.onresult = function(event) {
                    let finalTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript;
                        }
                    }
                    
                    if (finalTranscript) {
                        processVoiceInput(finalTranscript);
                    }
                };

                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    isListening = false;
                    document.getElementById('voiceButton').classList.remove('listening');
                    document.getElementById('listeningIndicator').classList.remove('active');
                    
                    if (event.error === 'no-speech') {
                        addMessage("I didn't hear anything. Please try again.", 'bot');
                    }
                };
            }
        }

        function saveApiKey() {
            apiKey = document.getElementById('apiKeyInput').value.trim();
            if (apiKey) {
                localStorage.setItem('vumc_api_key', apiKey);
                document.getElementById('apiKeyBanner').style.display = 'none';
                document.getElementById('voiceButton').disabled = false;
                addMessage("Great! I'm ready to help. Tap the microphone to ask a question.", 'bot');
            }
        }

        function toggleVoice() {
            if (!apiKey) {
                alert('Please enter your OpenAI API key first');
                return;
            }

            if (isListening) {
                recognition.stop();
            } else {
                recognition.start();
            }
        }

        function processVoiceInput(text) {
            addMessage(text, 'user');
            askQuestion(text);
        }

        async function askQuestion(question) {
            addMessage('<span class="loading-dots">Thinking</span>', 'bot', true);
            
            try {
                const response = await callOpenAI(question);
                removeLastBotMessage();
                addMessage(response.answer, 'bot');
                
                // Speak the response
                speak(response.spokenAnswer);
                
                // Add protocol links if relevant
                if (response.protocols.length > 0) {
                    let linksHtml = '<div style="margin-top: 12px; font-size: 14px;">ðŸ“„ Related protocols:</div>';
                    response.protocols.forEach(p => {
                        linksHtml += `<a href="${p.url}" target="_blank" class="protocol-link">ðŸ“± ${p.name}</a>`;
                    });
                    appendToLastBotMessage(linksHtml);
                }
                
            } catch (error) {
                removeLastBotMessage();
                addMessage("Sorry, I encountered an error. Please try again.", 'bot');
                console.error(error);
            }
        }

        async function callOpenAI(question) {
            // Find relevant protocols
            const relevantProtocols = findRelevantProtocols(question);
            
            const systemPrompt = `You are a concise medical assistant for VUMC trauma guidelines. 
                Provide brief, clear answers optimized for voice output. 
                Keep responses under 100 words when possible.
                Available protocols: ${Object.keys(protocols).join(', ')}`;

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-4',
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: question }
                    ],
                    temperature: 0.3,
                    max_tokens: 200
                })
            });

            if (!response.ok) {
                throw new Error('API request failed');
            }

            const data = await response.json();
            const answer = data.choices[0].message.content;
            
            // Create a shorter version for speech
            const spokenAnswer = answer.length > 150 ? 
                answer.substring(0, 150) + '... Check the protocol for full details.' : 
                answer;

            return {
                answer: answer,
                spokenAnswer: spokenAnswer,
                protocols: relevantProtocols
            };
        }

        function findRelevantProtocols(question) {
            const questionLower = question.toLowerCase();
            const relevant = [];
            
            Object.entries(protocols).forEach(([name, url]) => {
                if (questionLower.includes(name.toLowerCase()) ||
                    name.toLowerCase().split(' ').some(word => questionLower.includes(word))) {
                    relevant.push({ name, url });
                }
            });
            
            return relevant;
        }

        function speak(text) {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9;
            utterance.pitch = 1;
            utterance.volume = 1;
            
            // Use a clear voice
            const voices = speechSynthesis.getVoices();
            const englishVoice = voices.find(voice => 
                voice.lang.startsWith('en') && voice.name.includes('Samantha')
            ) || voices.find(voice => voice.lang.startsWith('en'));
            
            if (englishVoice) {
                utterance.voice = englishVoice;
            }
            
            speechSynthesis.speak(utterance);
        }

        function addMessage(content, type, isHtml = false) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            
            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            
            if (isHtml || content.includes('<')) {
                bubble.innerHTML = content;
            } else {
                bubble.textContent = content;
            }
            
            messageDiv.appendChild(bubble);
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function removeLastBotMessage() {
            const messages = document.querySelectorAll('.bot-message');
            if (messages.length > 0) {
                messages[messages.length - 1].remove();
            }
        }

        function appendToLastBotMessage(html) {
            const messages = document.querySelectorAll('.bot-message .bubble');
            if (messages.length > 0) {
                messages[messages.length - 1].innerHTML += html;
            }
        }

        // Prevent scrolling when keyboard appears
        document.addEventListener('touchmove', function(e) {
            if (e.target.closest('.chat-container')) return;
            e.preventDefault();
        }, { passive: false });
    </script>
</body>
</html>